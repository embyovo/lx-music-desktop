name: Build

on:
  push:
    branches:
      - master
  workflow_dispatch:

env:
  IS_CI: 'true'
  GH_OWNER: embyovo  # 你的 GitHub 用户名
  GH_REPO: lx-music-desktop  # 你的仓库名

jobs:
  Windows:
    name: Windows
    runs-on: windows-latest
    permissions:
      contents: write
      packages: write
    steps:
      - name: Check out git repository
        uses: actions/checkout@v4

      - name: Get npm cache directory
        shell: pwsh
        run: echo "NPM_CACHE=$(npm config get cache)" >> $env:GITHUB_ENV

      - name: Show Env
        run: echo "${{ env.NPM_CACHE }}"

      - name: Setup Node Env
        env:
          NPM_CACHE: ${{ env.NPM_CACHE }}
        uses: ./.github/actions/setup

      - name: Build src code
        run: |
          git status --porcelain
          npm run build

      - name: Release package
        run: |
          npm run publish:win:7z:x64
          npm run publish:win:7z:arm64
          npm run publish:win:setup:arm64
          npm run publish:win:setup:x64
        env:
          GITHUB_TOKEN: ${{ secrets.TOKEN }}
          BT_TOKEN: ${{ secrets.BT_TOKEN }}
          ELECTRON_BUILDER_GITHUB_TOKEN: ${{ secrets.TOKEN }}
          OWNER: ${{ env.GH_OWNER }}
          REPO: ${{ env.GH_REPO }}
          # 兜底：强制指定 electron-builder 发布仓库
          GH_REPO_OWNER: ${{ env.GH_OWNER }}
          GH_REPO_NAME: ${{ env.GH_REPO }}

      - name: Generate file MD5
        run: |
          cd build
          Get-FileHash *.exe,*.7z -Algorithm MD5 | Format-List

  Windows_7:
    name: Windows_7
    runs-on: windows-latest
    permissions:
      contents: write
      packages: write
    steps:
      - name: Check out git repository
        uses: actions/checkout@v4

      - name: Get npm cache directory
        shell: pwsh
        run: echo "NPM_CACHE=$(npm config get cache)" >> $env:GITHUB_ENV

      - name: Setup Node Env
        env:
          NPM_CACHE: ${{ env.NPM_CACHE }}
        uses: ./.github/actions/setup

      - name: Prepare win7 undici env
        run: |
          npm install undici@5
          Set-Content -Path .\src\common\utils\request.ts -Value "export * from './request_node16'"

      - name: Build src code
        env:
          BUILD_WIN7: true
        run: |
          git status --porcelain
          npm run build

      - name: Prepare win7 electron env
        run: |
          npm install electron@22
          pip.exe install setuptools

      - name: Release win7 package
        run: |
          npm run publish:win7:setup:x64
          npm run publish:win7:7z:x64
          npm run publish:win7:7z:x86
        env:
          GITHUB_TOKEN: ${{ secrets.TOKEN }}
          BT_TOKEN: ${{ secrets.BT_TOKEN }}
          ELECTRON_BUILDER_GITHUB_TOKEN: ${{ secrets.TOKEN }}
          OWNER: ${{ env.GH_OWNER }}
          REPO: ${{ env.GH_REPO }}
          GH_REPO_OWNER: ${{ env.GH_OWNER }}
          GH_REPO_NAME: ${{ env.GH_REPO }}

      - name: Generate file MD5
        run: |
          cd build
          Get-FileHash *.exe,*.7z -Algorithm MD5 | Format-List

  Mac:
    name: Mac
    runs-on: macos-latest
    permissions:
      contents: write
      packages: write
    steps:
      # 修复：Mac 任务新增 checkout 步骤（必须是第一步）
      - name: Check out git repository
        uses: actions/checkout@v4

      - name: Install python3 setuptools
        run: brew install python-setuptools

      - name: Get npm cache directory
        shell: bash
        run: echo "NPM_CACHE=$(npm config get cache)" >> $GITHUB_ENV

      - name: Show Env    
        run: echo "${{ env.NPM_CACHE }}"

      - name: Setup Node Env
        env:
          NPM_CACHE: ${{ env.NPM_CACHE }}
        uses: ./.github/actions/setup

      - name: Build src code
        run: |
          git status --porcelain
          npm run build

      - name: Release package
        run: |
          npm run publish:mac:dmg
          npm run publish:mac:dmg:arm64
        env:
          GITHUB_TOKEN: ${{ secrets.TOKEN }}
          BT_TOKEN: ${{ secrets.BT_TOKEN }}
          ELECTRON_BUILDER_GITHUB_TOKEN: ${{ secrets.TOKEN }}
          OWNER: ${{ env.GH_OWNER }}
          REPO: ${{ env.GH_REPO }}
          GH_REPO_OWNER: ${{ env.GH_OWNER }}
          GH_REPO_NAME: ${{ env.GH_REPO }}

      - name: Generate file MD5
        run: |
          cd build
          md5 *.dmg

  Linux:
    name: Linux
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    steps:
      # 修复：checkout 移到第一步，先拉代码再装系统包
      - name: Check out git repository
        uses: actions/checkout@v4

      - name: Install package
        run: sudo apt-get update && sudo apt-get install -y rpm libarchive-tools

      - name: Get npm cache directory
        shell: bash
        run: echo "NPM_CACHE=$(npm config get cache)" >> $GITHUB_ENV

      - name: Show Env
        run: echo "${{ env.NPM_CACHE }}"

      - name: Setup Node Env
        env:
          NPM_CACHE: ${{ env.NPM_CACHE }}
        uses: ./.github/actions/setup

      - name: Build src code
        run: |
          git status --porcelain
          npm run build

      - name: Release package
        run: |
          npm run publish:linux:deb:amd64
          npm run publish:linux:deb:arm64
          npm run publish:linux:deb:armv7l
          npm run publish:linux:appImage
          npm run publish:linux:rpm
          npm run publish:linux:pacman
        env:
          GITHUB_TOKEN: ${{ secrets.TOKEN }}
          BT_TOKEN: ${{ secrets.BT_TOKEN }}
          ELECTRON_BUILDER_GITHUB_TOKEN: ${{ secrets.TOKEN }}
          OWNER: ${{ env.GH_OWNER }}
          REPO: ${{ env.GH_REPO }}
          GH_REPO_OWNER: ${{ env.GH_OWNER }}
          GH_REPO_NAME: ${{ env.GH_REPO }}

      - name: Generate file MD5
        run: |
          cd build
          md5sum *.deb *.rpm *.pacman *.AppImage
